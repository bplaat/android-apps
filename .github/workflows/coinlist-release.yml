name: coinlist-release

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  coinlist-release:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Install bob
        run: cargo install --git https://github.com/bplaat/crates.git bob
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 14742923
      - name: Build release
        working-directory: bin/coinlist
        run: |
          export JAVA_HOME=$JAVA_HOME_21_X64
          export PATH=$JAVA_HOME/bin:$PATH
          echo "${{ secrets.COINLIST_KEYSTORE }}" | base64 --decode > keystore.jks
          bob build --release
      - name: Create Git tag and GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        working-directory: bin/coinlist
        run: |
          TAG_VERSION=$(sed -nE 's/^[[:space:]]*version[[:space:]]*=[[:space:]]*"([^"]+)".*/\1/p' bob.toml)
          gh release create "coinlist/v${TAG_VERSION}" --title "CoinList v${TAG_VERSION}" target/release/coinlist-${TAG_VERSION}.apk
